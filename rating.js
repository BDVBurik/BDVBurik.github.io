!function(){"use strict";function i(r){var m=new Lampa.Reguest,t=n(r.title),e=r.release_date||r.first_air_date||r.last_air_date||"0000",o=parseInt((e+"").slice(0,4)),d=r.original_title||r.original_name,e="https://worker-patient-dream-26d7.bdvburik.workers.dev/",s={id:r.id,url:e+"https://kinopoiskapiunofficial.tech/",rating_url:e+"https://rating.kinopoisk.ru/",headers:{"X-API-KEY":"7fdba022-d72e-43d7-aa82-4ce175c280a6"},cache_time:864e5};function i(t){var e,i,n,a,l;t&&t.length&&(i=e=!1,t.forEach(function(t){var e=t.start_date||t.year||"0000";t.tmp_year=parseInt((e+"").slice(0,4))}),r.imdb_id&&(n=t.filter(function(t){return(t.imdb_id||t.imdbId)==r.imdb_id})).length&&(t=n,i=e=!0),1==(n=(n=t).length&&(d&&(t=n.filter(function(t){return u(t.orig_title||t.nameOriginal,d)||u(t.en_title||t.nameEn,d)||u(t.title||t.ru_title||t.nameRu,d)})).length&&(n=t,e=!0),r.title&&(t=n.filter(function(t){return u(t.title||t.ru_title||t.nameRu,r.title)||u(t.en_title||t.nameEn,r.title)||u(t.orig_title||t.nameOriginal,r.title)})).length&&(n=t,e=!0),1<n.length)&&o&&(t=(t=n.filter(function(t){return t.tmp_year==o})).length?t:n.filter(function(t){return t.tmp_year&&t.tmp_year>o-2&&t.tmp_year<o+2})).length?t:n).length&&e&&!i&&(e=o&&n[0].tmp_year?n[0].tmp_year>o-2&&n[0].tmp_year<o+2:e)&&(e=!1,d&&(e|=p(n[0].orig_title||n[0].nameOriginal,d)||p(n[0].en_title||n[0].nameEn,d)||p(n[0].title||n[0].ru_title||n[0].nameRu,d)),r.title)&&(e|=p(n[0].title||n[0].ru_title||n[0].nameRu,r.title)||p(n[0].en_title||n[0].nameEn,r.title)||p(n[0].orig_title||n[0].nameOriginal,r.title)),1==n.length)&&e?(a=n[0].kp_id||n[0].kinopoisk_id||n[0].kinopoiskId||n[0].filmId,l=function(){m.clear(),m.timeout(15e3),m.silent(s.url+"api/v2.2/films/"+a,function(t){return f(g(s.id,{kp:t.ratingKinopoisk,imdb:t.ratingImdb,timestamp:(new Date).getTime()}))},function(t,e){c(m.errorDecode(t,e))},!1,{headers:s.headers})},m.clear(),m.timeout(5e3),m.native(s.rating_url+a+".xml",function(t){if(0<=t.indexOf("<rating>"))try{var e=0,i=0,n=$($.parseXML(t)),a=n.find("kp_rating"),r=(a.length&&(e=parseFloat(a.text())),n.find("imdb_rating"));return r.length&&(i=parseFloat(r.text())),f(g(s.id,{kp:e,imdb:i,timestamp:(new Date).getTime()}))}catch(t){}l()},function(t,e){l()},!1,{dataType:"text"})):f(g(s.id,{kp:0,imdb:0,timestamp:(new Date).getTime()}))}function n(t){return t.replace(/[\s.,:;’'`!?]+/g," ").trim()}function a(t){return n(t.toLowerCase().replace(/[\-\u2010-\u2015\u2E3A\u2E3B\uFE58\uFE63\uFF0D]+/g,"-").replace(/ё/g,"е"))}function p(t,e){return"string"==typeof t&&"string"==typeof e&&a(t)===a(e)}function u(t,e){return"string"==typeof t&&"string"==typeof e&&-1!==a(t).indexOf(a(e))}function c(t){Lampa.Noty.show("Рейтинг KP: "+t)}function g(t,e){var i=(new Date).getTime(),n=Lampa.Storage.cache("kp_rating",500,{});return n[t]?i-n[t].timestamp>s.cache_time?(e.timestamp=i,n[t]=e,Lampa.Storage.set("kp_rating",n)):e=n[t]:(n[t]=e,Lampa.Storage.set("kp_rating",n)),e}function f(t){var e,i;t&&(e=isNaN(t.kp)||null===t.kp?"0.0":parseFloat(t.kp).toFixed(1),t=isNaN(t.imdb)||null===t.imdb?"0.0":parseFloat(t.imdb).toFixed(1),i=Lampa.Activity.active().activity.render(),$(".wait_rating",i).remove(),$(".rate--imdb",i).removeClass("hide").find("> div").eq(0).text(t),$(".rate--kp",i).removeClass("hide").find("> div").eq(0).text(e))}var l,h,e=function(t){var e=(new Date).getTime(),i=Lampa.Storage.cache("kp_rating",500,{});{if(!i[t])return!1;if(e-i[t].timestamp>s.cache_time)return delete i[t],Lampa.Storage.set("kp_rating",i),!1}return i}(s.id);e?f(e[s.id]):(l=s.url,h=Lampa.Utils.addUrlComponent(l+"api/v2.1/films/search-by-keyword","keyword="+encodeURIComponent(t)),console.log("clean_title",t),l=r.imdb_id?Lampa.Utils.addUrlComponent(l+"api/v2.2/films","imdbId="+encodeURIComponent(r.imdb_id)):h,m.clear(),m.timeout(15e3),m.silent(l,function(t){t.items&&t.items.length?i(t.items):t.films&&t.films.length?i(t.films):l!==h?(m.clear(),m.timeout(15e3),m.silent(h,function(t){t.items&&t.items.length?i(t.items):t.films&&t.films.length?i(t.films):i([])},function(t,e){c(m.errorDecode(t,e))},!1,{headers:s.headers})):i([])},function(t,e){c(m.errorDecode(t,e))},!1,{headers:s.headers}))}window.rating_plugin||(window.rating_plugin=!0,Lampa.Listener.follow("full",function(t){var e;"complite"==t.type&&(e=t.object.activity.render(),$(".rate--kp",e).hasClass("hide"))&&!$(".wait_rating",e).length&&($(".info__rate",e).after('<div style="width:2em;margin-top:1em;margin-right:1em" class="wait_rating"><div class="broadcast__scan"><div></div></div><div>'),i(t.data.movie))}))}();